---
title: 高度な実行時オプション
description: Qiskit ランタイムプリミティブでビルドする際のオプションを指定します
---

# Qiskit ランタイムの高度なオプション

プリミティブを呼び出すときは、 `Options` クラスを使用するか、 `run` メソッドを使用してオプションを渡すことができます。 `Options`クラスでは、`resilience_level`のような一般的に使用されるオプションが最初のレベルにあります。 その他のオプションは異なるカテゴリに分類されます:

![options](/images/build/options.png)

<Admonition type="info" title="Attention">
    このセクションでは、Qiskit Runtime [Options](../api/qiskit-ibm-runtime/qiskit_ibm_runtime.options.Options) (`qiskit_ibm_runtime` からインポート) に焦点を当てます。 ほとんどの`primitives`インターフェースは実装全体で一般的ですが、ほとんどの`Options`はそうではありません。 Consult the
    corresponding API references for information about the `qiskit.primitives` and `qiskit_aer.primitives` options.
</Admonition>

## Optionsクラスをインスタンス化

以下の例では、 `Options` クラスのインスタンスを作成します。 `optimization_level` は最初のレベルのオプションで、入力パラメータとして渡すことができます。 実行環境に関連するオプションは `environment` パラメータを使用して渡されます。

```python
from qiskit_ibm_runtime import Options

options = Options(optimization_level=3, environment={"log_level": "INFO"})
```

`Options`クラスは自動補完をサポートします。 `Options`クラスのインスタンスを作成すると、auto-complete を使ってどのようなオプションが利用可能かを確認できます。 カテゴリのいずれかを選択した場合は、再びauto-complete を使用して、そのカテゴリの下で利用可能なオプションを確認できます。 

```python
from qiskit_ibm_runtime import Options

options = Options()
options.resilience_level = 1
options.execution.shots = 2048
```

## プリミティブにオプションを渡します

### オプションクラス

`見積もり`または`Sampler`クラスのインスタンスを作成する場合は、作成したばかりの`options`を渡すことができます。 これらのオプションは `run()` を使用して計算を実行するときに適用されます。  例 

```python
estimator = Estimator(session=backend, options=options)
result = estimator.run(circuit, observable).result()
print(f">>> Metadata: {result.metadata[0]}")
```

### Run() メソッド

`run()`メソッドを使うことでオプションを渡すことができます。 これにより、特定の実行のために `Estimator` または `Sampler` インスタンスを作成するときに指定したオプションが上書きされます。 

ほとんどのユーザーはジョブレベルでいくつかのオプションしか上書きしないため、オプションが含まれているカテゴリを指定する必要はありません。 例えば、`execution={"shots": 1024}` の代わりに `shots=1024` を指定します (これは有効です)。 

```python
estimator = Estimator(session=backend, options=options)
result = estimator.run(circuit, observable, shots=1024).result()
print(f">>> Metadata: {result.metadata[0]}")
```

## 一般的に使用されるオプション

利用可能なオプションは多数ありますが、最も一般的に使用されるのは以下の通りです:

### ショット

一部のアルゴリズムでは、特定のショット数を設定することがルーチンの中核となります。 以前は、`backend.run()` の呼び出し中にショットを設定することができました。 例えば、 `backend.run(shots=1024)` です。 これで、この設定は、
オプションの実行の一部となりました("2番目のレベルのオプション")。 これはプリミティブセットアップ中に行うことができます。

```python
from qiskit_ibm_runtime import Estimator, Options

options = Options()
options.execution.shots = 1024

estimator = Estimator(session=backend, options=options)
```

繰り返し(プリミティブな呼び出し)の間で設定されたショットの数を変更する必要がある場合は、`run()`メソッドで直接
ショットを設定できます。 初期設定の `shots` を上書きします。

```python
from qiskit_ibm_runtime import Estimator

estimator = Estimator(session=backend)

estimator.run(circuits=circuits, observables=observables, shots=50)

# other logic

estimator.run(circuits=circuits=circuits=observables, shots=100)
```

プリミティブオプションの詳細については、
[Options class API reference](../api/qiskit-ibm-runtime/qiskit_ibm_runtime.options.Options)を参照してください。

### ランタイムのコンパイル

QisKit Runtime プリミティブは、ターゲットシステムでの実行に適した回路で呼び出されることを期待します。 これは、ユーザーがすでにターゲットシステムのネイティブゲートセットと接続制約を尊重するように回路を移植していることを意味します。

QisKit Runtime プリミティブは、最適化レベルオプションによって制御される最適化度を持つ回路を最適化するために、追加のランタイムコンパイルを実行することができます。 選択した最適化レベルはコンパイル戦略に影響し、より高いレベルでより高価または積極的な最適化を呼び出すことができます。

詳細については、
[Runtime compilation topic](configure-runtime-compilation#set-the-optimization-level) の最適化レベル表を参照してください。

<Admonition>
    現在展開されている Qiskit Runtime プリミティブでは、最適化レベル 2 と 3 は レベル 1 と同じように動作します。 より高度な最適化を使用したい場合は、Qiskit transpiler をローカルで使用し、[`skip_transpilation=True`](../api/qiskit-ibm-runtime/qiskit_ibm_runtime.options.TransspilationOptions#skip_transpilation) を設定し、移調された回路をプリミティブに渡します。  手順については、format@@0(https://learning.quantum.ibm.com/tutorial/submiting-user-transpiled-circuits-using-primitives)チュートリアルを参照してください。
</Admonition>

最適化レベルのオプションは「ファーストレベルのオプション」で、以下のように設定することができます:

```python
from qiskit_ibm_runtime import Estimator, Options

options = Options(optimization_level=1)

# or..
options = Options()
options.optimization_level = 1

estimator = Estimator(session=backend, options=options)
```

すべてのオプションのランタイムコンパイルステップをオフにするには、次のように「第2レベルのオプション」が必要です。

```python
from qiskit_ibm_runtime import Estimator, Options

options = Options()
options.transpilation.skip_transpilation = True

estimator = Estimatelator(session=backend, options=options)
```

詳細と高度な移調オプションのリストについては、
[ランタイム・コンパイル・トピック](configure-runtime-compilation#transpilation-table)の詳細な移調オプションテーブルを参照してください。

### エラーの緩和方法

異なるエラー緩和方法を活用し、これらが
アルゴリズムのパフォーマンスにどのように影響するかを確認することができます。 これらは `resilience_level` オプションで設定することもできます。 `Sampler`と`Estimator`では、レベルごとに
を選択します。 詳細については、
[エラー軽減の設定](configure-error-軽減)をご覧ください。

構成は他のオプションと似ています:

```python
from qiskit_ibm_runtime import Estimator, Options

options = Options(resilience_level = 2)

# or...

options = Options()
options.resilience_level = 2

estimator = Estimator(session=backend, options=options)
```

## 次のステップ

<Admonition type="tip" title="Recommendations">
    - [Estimater API reference](../api/qiskit-ibm-runtime/qiskit_ibm_runtime.Estimaator#estimator)に`Estimaator` メソッドの詳細があります。
    - format@@0(../api/qiskit-ibm-runtime/qiskit_ibm_runtime.Sampler#sampler)に`Sampler`メソッドの詳細があります。
    - format@@0(../api/qiskit-ibm-runtime/qiskit_ibm_runtime.options.Options)で利用可能なすべてのオプションを見つけます。
    - [runtime compilation](../run/configure-runtime-compilation)と[error 軽減](../run/configure-error-軽減)についての詳細を見つけます。
</Admonition>
