---
title: Qiskit プリミティブによる正確なシミュレーション
description: Qiskit 参照プリミティブを使ってシミュレートします。 Estimate プリミティブで期待値を計算する方法と、サンプラープリミティブで回路の出力確率を計算する方法
---

# Qiskit プリミティブによる正確なシミュレーション

Qiskit の参照プリミティブはローカルの状態ベクトルシミュレーションを実行することができます。これは迅速なプロトタイピングアルゴリズムに役立ちます。 

`Estimatel` プリミティブは期待値を計算でき、`Sampler`プリミティブは回路の出力確率を計算できます。 

## `Estimator` プリミティブで期待値を計算する

これらの指示に従って、[`qiskit.primitives.Estimator`](../api/qiskit/qiskit.primitives.Estimator) プリミティブを使用して、特定の量子回路に対して観測可能な期待値を取得します。

<Admonition type="note">
  このガイドでは Qiskitのリファレンス実装を使用していますが、`Estimator` プリミティブは、[`qiskit.primitives.BackendEstimator`](../api/qiskit/qiskit.primitives.BackendEstiator) を使用して、任意のプロバイダで実行することができます。

```python
from qiskit.primitives import BackendEstimator
from <some_qiskit_provider> import QiskitProvider

provider = QiskitProvider()
backend = provider.get_backend('backend_name')
estimator = BackendEstimator(backend)
```

  プリミティブをネイティブに実装するプロバイダがいくつかあります(詳細については[Qiskit エコシステムのページ](https://qiskit.github.io/ecosystem/#primitives)を参照してください)。

</Admonition>

### 観測可能ファイルを初期化

最初のステップは、予想される値を計算するオブザベーションを定義することです。 それぞれの `BaseOperator` は、[`qiskit.quantum_info`](../api/qiskit/quantum_info) の演算子のように任意です。
その中では、[`qiskit.quantum_info.SparsePauliOp`](../api/qiskit/qiskit.quantum_info.SparsePauliOp) を使用することが望ましいです。

```python
from qiskit.quantum_info import SparsePauliOp

observable = SparsePauliOp(["II", "XX", "Y", "ZZ"], coeffs=[1, 1, -1])
```

### QuantumCircuit を初期化

次に、期待値を取得する[`qiskit.circuit`](../api/qiskit/qiskit.circuit.QuantumCircuit)を作成します。

```python
from qisKit import QuantumCircuit

qc = QuantumCircuit(2)
qc.h(0)
qc.cx(0,1)
qc.draw("mpl")
```

![Initial QuantumCircuit](/images/verify/simulate-with-qiskit-primitives/estimaator-initialize.png)

<Admonition type="note">
  [`qiskit.circuit.QuantumCircuit`](../api/qiskit/qiskit.circuit.QuantumCircuit) [`qiskit.primitives.Estimater`](../api/qiskit/qiskit.primitivitives.Estimaator) に渡す測定値を含めてはなりません。
</Admonition>

### 「推定値」を初期化する

次に、[`qiskit.primitives.Estimator`](../api/qiskit/qiskit.primitives.Estimator) をインスタンス化します。

```python
from qiskit.primitives import Estimator

estimator = Estimator()
```

### 実行して結果を取得する

`estimator`を定義したので、[`qiskit.primitives.Estimator.run`](../api/qiskit/qiskit.primitives.Estimaator#run) メソッド
を呼び出すと、[`qiskit.providers.JobV1`](../api/qiskit/qiskit.providers.JobV1`)のインスタンスが返されます。 ジョブの結果([`qiskit.primitives.EstimaatorResult`](../api/qiskit/qiskit.primitives.EstimaatorResult) オブジェクト)
[`qiskit.providers.JobV1.result`](../api/qiskit/qiskit.providers.JobV1#result) メソッドの結果を取得できます。

```python
job = estimator.run(qc, observable)
result = job.result()
print(result)
```

```python
EstimatorResult(values=array([4.]), metadata=[{}])
```

この例では、1つの[`qiskit.circuit.QuantumCircuit`](../api/qiskit/qiskit.circuit.QuantumCircuit) と1つの観測可能なもののみを使用します。 複数の回路と観測値の期待値を取得したい場合は、[`qiskit.circuit.QuantumCircuit`](../api/qiskit/qiskit/qiskit) の `list` を渡すことができます。 ircuit.QuantumCircuit) [`qiskit.primitives.Estimator.run`](../api/qiskit/qiskit.primitives.Estimaator#run) メソッドへの `BaseOperator` のリスト。 両方の `list` の長さは同じでなければなりません。

#### 期待値を取得する

これらの結果から、期待される値を属性 [`qiskit.primitives.EstimaatorResult.values`](../api/qiskit/qiskit.primitives.EstimaatorResult#values) で抽出できます。

[`qiskit.primitives.EstimaatorResult.values`](../api/qiskit/qiskit.primitives.EstimaatorResult#values) は `numpy を返します。 darray`
`i`<sup>番目の</sup> 要素は、`i`<sup>番目の</sup> 回路と`i`<sup>番目の</sup> 番目の観測可能に対応する期待値です。

```python
exp_value = result.values[0]
print(exp_value)
```

```python
3.999999999999999
```

### 「推定値」によるパラメータ回路

[`qiskit.primitives.Estimator`](../api/qiskit/qiskit.primitives.Estimator) プリミティブは以下のようなバインドされていないパラメータ回路で実行できます。
回路のパラメータに手動で値をバインドし、前の例の手順に従うこともできます。

```python
from qiskit.circuit import Parameter

theta = Parameter('θ')
param_qc = QuantumCircuit(2)
param_qc.ry(theta, 0)
param_qc.cx(0,1)
print(param_qc.draw())
```

```
     <unk> ─────────<unk>
q_0: <unk> Ry(q) ├────
     ├──────────
q_1: ───────────────────<unk> X <unk>
              ├──────────────────<unk> Aformat@@4
```

前のケースとの主な違いは、期待値を`float`のリスト`リスト`として評価するパラメータ値のセットを指定する必要があることです。
外側の `list` の `i`<sup>第</sup> 要素は、`i`<sup>第</sup> 回路に対応するパラメータ値のセットであり、監視可能です。

```python
import numpy as np

parameter_values = [[0], [np.pi/6], [np.pi/2]]

job = estimator.run([param_qc]*3, [observable]*3, parameter_values=parameter_values)
values = job.result().values

for i in range(3):
    print(f"Parameter: {parameter_values[i][0]:.5f}\t Expectation value: {values[i]}")
```

```
パラメータ: 0.00000 期待値: 2.0
パラメータ: 0.52360 期待値: 3.0
パラメータ: 1.57080 期待値: 4.0
```

### 実行オプションの変更

ワークフローでは、ショット数などのプリミティブランオプションのチューニングが必要になる場合があります。

デフォルトでは、参照[`qiskit.primitives.Estimaator`](../api/qiskit/qiskit.primitives.Estimaator) クラスは[`qiskit.quantum_info.Statevector`](../api/qiskit/qiskit.quantum_info.Statevector)クラスに基づいて正確な状態ベクトル計算を実行します。 ただし、`shots` の数が設定されている場合、これはショットノイズを含めるように変更することができます。 再現性のために、以下の例では、 `seed` も設定されます。

[`qiskit.primitives.Estimaator`](../api/qiskit/qiskit.primitives.Estimaator)には2つの方法があります。

-   [`qiskit.primitives.Estimator.run`](../api/qiskit/qiskit.primitives.Estimator#run) メソッドにキーワード引数を設定します。
-   [`qiskit.primitives.Estimator`](../api/qiskit/qiskit.primitives.Estimator) オプションを変更します。

#### キーワード引数を[`qiskit.primitives.Estimator.run`](../api/qiskit/qiskit.primitives.Estimator#run) に設定します。

特定の実行時の設定のみを変更したい場合は、[`qiskit.primitives.Estimator.run`](../api/qiskit/qiskit.primitives.Estimator#run) メソッドの中でオプションを設定する方が便利です。 キーワード引数として渡すことでこれを行うことができます。

```python
job = estimator.run(qc, observable, shots=2048, seed=123)
result = job.result()
print(result)
```

```python
EstimatorResult(values=array([4.]), metadata=[{'variance': 3.552713678800501e-15, 'shots': 2048}])
```

```python
print(result.values[0])
```

```python
3.999999998697238
```

#### [`qiskit.primitives.Estimator`](../api/qiskit/qiskit.primitives.Estimator) オプションを変更する

複数の実行時に設定値を保持したい場合は、[`qiskit.primitives.Estimator`](../api/qiskit/qiskit.primitives.Estimator) オプションを変更することをお勧めします。 これにより、同じ [`qiskit.primitives.Estimaator`](../api/qiskit/qiskit.primitives) を使用できます。 stimator) オブジェクトは、[`qiskit.primitives.Estimator.run`](../api/qiskit/qiskit.primitives.Estimator#run) を使用するたびに、設定値を
に書き換えなくても何度もオブジェクトになります。

#### 既存の[`qiskit.primitives.Estimaator`](../api/qiskit/qiskit.primitives.Estimater)

すでに定義されている[`qiskit.primitives.Estimator`](../api/qiskit/qiskit.primitives.Estimator)のオプションを変更したい場合は、メソッド[`qiskit.primitives.Estimaator.set_options`](../api/qiskit/qiskit.primitives.Estimator#set_options)を使用して、キーワード引数として新しいオプションを導入できます。

```python
estimator.set_options(shots=2048, seed=123)

job = estimator.run(qc, observable)
result = job.result()
print(result)
```

```python
EstimatorResult(values=array([4.]), metadata=[{'variance': 3.552713678800501e-15, 'shots': 2048}])
```

```python
print(result.values[0])
```

```python
3.999999998697238
```

#### 新しい[`qiskit.primitives.Estimater`](../api/qiskit/qiskit.primitives.Estimater) をオプションで定義します。

新しいオプションを使って新しい [`qiskit.primitives.Estimaator`](../api/qiskit/qiskit.primitives.Estimaator) を定義する場合は、次のように、 `dict` を定義します。

```python
options = {"shots": 2048, "seed": 123}
```

新しい[`qiskit.primitives.Estimatelator`](../api/qiskit/qiskit.primitives.Estimaator) に`options`引数を使って導入することができます。

```python
estimator = Estimator(options=options)

job = estimator.run(qc, observable)
result = job.result()
print(result)
```

```python
EstimatorResult(values=array([4.]), metadata=[{'variance': 3.552713678800501e-15, 'shots': 2048}])
```

```python
print(result.values[0])
```

```python
3.999999998697238
```

## `Sampler`プリミティブで回路の出力確率を計算する

[`qiskit.primitives.Sampler`](../api/qiskit/qiskit.primitives.Sampler)の量子回路の確率分布を取得するには、以下の手順に従ってください。

<Admonition type="note">
  このガイドでは Qiskitのリファレンス実装を使用していますが、`Sampler` プリミティブは [`qiskit.primitives.BackendSampler`](../api/qiskit/qiskit.primitives.BackendSampler) を使用して任意のプロバイダで実行できます。

```python
from qiskit.primitives import BackendSampler
from <some_qiskit_provider> import QiskitProvider

provider = QiskitProvider()
backend = provider.get_backend('backend_name')
samler = BackendSampler(backend)
```

  プリミティブをネイティブに実装するいくつかのプロバイダがあります(詳細については、[Qiskit エコシステムのページ](https://qiskit.github.io/ecosystem#providers)を参照してください)。

</Admonition>

### QuantumCircuit を初期化

最初のステップは確率分布を求める[`qiskit.circuit.QuantumCircuit`](../api/qiskit/qiskit.circuit.QuantumCircuit)を作成することです。

```python
from qisKit import QuantumCircuit

qc = QuantumCircuit(2)
qc.h(0)
qc.cx(0,1)
qc.measure_all()
qc.draw("mpl")
```

![Initial QuantumCircuit](/images/verify/simulate-with-qiskit-primitives/sampler-initialize.png)

<Admonition type="note">
[`qiskit.circuit.QuantumCircuit`](../api/qiskit/qiskit.circuit.QuantumCircuit) [`qiskit.primitives.Sampler`](../api/qiskit/qiskit.primitives.Sampler)に渡す場合は、測定値を含める必要があります。
</Admonition>

### `Sampler`を初期化

次に、[`qiskit.primitives.Sampler`](../api/qiskit/qiskit.primitives.Sampler)インスタンスを作成します。

```python
from qiskit.primitives import Sampler

sampler = Sampler()
```

### 実行して結果を取得する

これで、`sampler`を定義しました。[`qiskit.primitives.Sampler.run`](../api/qiskit/qiskit.primitives.Sampler#run) メソッドを呼び出し、[`qiskit.providers.JobV1`](../api/qiskit/qiskit.providers.JobV1`)のインスタンスを返します。 [`qiskit.primitives.SamplerResult`](../api/qiskit/qiskit.primitives.SamplerResult) オブジェクトとして、[`qiskit.providers.JobV1.result`](../api/qiskit/qiskit.providers.JobV1#result) メソッドを使用して結果を取得できます。

```python
job = sampler.run(qc)
result = job.result()
print(result)
```

```python
SamplerResult(quasi_dists=[{0: 0.4999999999999999, 3: 0.4999999999999999}], metadata=[{}])
```

この例では、[`qiskit.circuit.QuantumCircuit`](../api/qiskit/qiskit.circuit.QuantumCircuit) [`qiskit.quantumCircuit`](../api/qiskit/qiskit.circuit.QuantumCircuit) インスタンスを[`qiskit.primitives.Sampler.run`](../api/qiskit/qiskit.primitives.Sampler#run) メソッドに渡すことで、複数の回路をサンプリングできます。

### 確率分布を取得する

これらの結果から、属性 [`qiskit.primitives.SamplerResult.quasi_dists`](../api/qiskit/qiskit.primitives.SamplerResult#quasi_dists) を使用して、準確率分布を抽出できます。

この例には1つの回路しかありませんが、[`qiskit.primitives.SamplerResult.quasi_dists`](../api/qiskit/qiskit.primitives.SamplerResult#quasi_dists) は[`qiskit.result.QuasiDistribution`](../api/qiskit/qiskit.result.quasiDistribution)のリストを返します。
`result.quasi_dists[i]` は `i`<sup>第</sup> 回路の準確率分布です。

<Admonition type="note">
準確率分布は、負の値も許容されるという確率分布とは異なります。
しかし、準確率は1までの確率を合計しなければなりません。
誤り緩和技術を使用すると、負の準確率が発生する可能性があります。
</Admonition>

```python
quasi_dist = result.quasi_dists[0]
print(quasi_dist)
```

```python
{0: 0.4999999999999999, 3: 0.4999999999999999}
```

#### バイナリ出力による確率分布

出力キーを小数の代わりにバイナリ文字列として見たい場合は、[`qiskit.result.QuasiDistribution.binary_probabibilities`](../api/qiskit/qiskit.result.QuasiDistribution#binary_probabilities) メソッドを使用します。

```python
print(quasi_dist.binary_probabilities())
```

```python
{'00': 0.4999999999999999, '11': 0.4999999999999999}
```

### `Sampler`によるパラメータ回路

[`qiskit.primitives.Sampler`](../api/qiskit/qiskit.primitives.Sampler) プリミティブは、以下のようなバインドされていないパラメータ回路で実行できます。
回路のパラメータに手動で値をバインドし、前の例の手順に従うこともできます。

```python
from qiskit.circuit import Parameter

theta = Parameter('θ')
param_qc = QuantumCircuit(2)
param_qc.ry(theta, 0)
param_qc.cx(0,1)
param_qc.measure_all()
print(param_qc.draw())
```

```
          ┌───────┐      ░ ┌─┐   
     q_0: ┤ Ry(θ) ├──■───░─┤M├───
          └───────┘┌─┴─┐ ░ └╥┘┌─┐
     q_1: ─────────┤ X ├─░──╫─┤M├
                   └───┘ ░  ║ └╥┘
  meas: 2/══════════════════╩══╩═
                            0  1 
```

前のケースとの主な違いは、期待値を`float`のリスト`リスト`として評価するパラメータ値のセットを指定する必要があることです。 外側の `list` の `i`<sup>第</sup> 要素は、`i`<sup>第</sup> 回路に対応するパラメータ値のセットです。

```python
import numpy as np

parameter_values = [[0], [np.pi/6], [np.pi/2]]

job = sampler.run([param_qc]*3, parameter_values=parameter_values)
dists = job.result().quasi_dists

for i in range(3):
    print(f"Parameter: {parameter_values[i][0]:.5f}\t Probabilities: {dists[i]}")
```

```
パラメータ: 0.00000確率: {0: 1.0}
パラメータ: 0.52360 確率: {0: 0.9330127018922194, 3: 0.0669872981077807}
パラメータ: 1.57080 確率: {0: 0.5000000000000001, 3: 0.4999999999999999}
```

### 実行オプションの変更

ワークフローでは、ショット数などのプリミティブランオプションのチューニングが必要になる場合があります。

デフォルトでは、リファレンス[`qiskit.primitives.Sampler`](../api/qiskit/qiskit.primitives.Sampler)クラスは[`qiskit.quantum_info.Statevector`](../api/qiskit/qiskit.quantum_info.Statevector)クラスに基づいて正確なステートベクトル
を実行します。 However, this can be
modified to include shot noise if the number of `shots` is set.
再現性のために、以下の例では、 `seed` も設定されます。

[`qiskit.primitives.Sampler`](../api/qiskit/qiskit.primitives.Sampler)にオプションを設定するには2つの主な方法があります。

-   [`qiskit.primitives.Sampler.run`](../api/qiskit/qiskit.primitives.Sampler#run) メソッドにキーワード引数を設定します。
-   [`qiskit.primitives.Sampler`](../api/qiskit/qiskit.primitives.Sampler) オプションを変更します。

#### キーワード引数を[`qiskit.primitives.Sampler.run`](../api/qiskit/qiskit.primitives.Sampler#run) に設定します。

特定の実行時にのみ設定を変更したい場合は、[`qiskit.primitives.Sampler.run`](../api/qiskit/qiskit.primitives.Sampler#run) メソッド内でオプションを設定する方が便利です。 キーワード引数として渡すことでこれを行うことができます。

```python
job = sampler.run(qc, shots=2048, seed=123)
result = job.result()
print(result)
```

```python
SamplerResult(quasi_dists=[{0: 0.5205078125, 3: 0.4794921875}], metadata=[{'shots': 2048}])
```

#### [`qiskit.primitives.Sampler`](../api/qiskit/qiskit.primitives.Sampler) オプションを変更する

いくつかの設定値を保持したい場合は、[`qiskit.primitives.Sampler`](../api/qiskit/qiskit.primitives.Sampler) オプションを変更することをお勧めします。 これにより、同じ[`qiskit.primitives.Sampler`](../api/qiskit/qiskit.primitives)を使用できます。 ampler) [`qiskit.primitives.Sampler.run`](../api/qiskit/qiskit.primitives.Sampler#run) を使用するたびに、設定値を書き換えることなく、望む回数だけオブジェクトを作成します。

#### 既存の[`qiskit.primitives.Sampler`](../api/qiskit/qiskit.primitives.Sampler) を変更する

すでに定義されている[`qiskit.primitives.Sampler`](../api/qiskit/qiskit.primitives.Sampler)のオプションを変更したい場合は、[`qiskit.primitives.Sampler.set_options`](../api/qiskit/qiskit.primitives.Sampler#set_options)を使用して、キーワード引数として新しいオプションを導入できます。

```python
sampler.set_options(shots=2048, seed=123)

job = sampler.run(qc)
result = job.result()
print(result)
```

```python
SamplerResult(quasi_dists=[{0: 0.5205078125, 3: 0.4794921875}], metadata=[{'shots': 2048}])
```

#### 新しい[`qiskit.primitives.Sampler`](../api/qiskit/qiskit.primitives.Sampler) を定義します。

新しい[`qiskit.primitives.Sampler`](../api/qiskit/qiskit.primitives.Sampler)を定義したい場合は、次のような `dict` を定義します。

```python
options = {"shots": 2048, "seed": 123}
```

新しい[`qiskit.primitives.Sampler`](../api/qiskit/qiskit.primitives.Sampler) に `options` 引数を使って導入できます。

```python
samler = Sampler(options=options)

job = sampler.run(qc)
result = job.result()
print(result)
```

```python
SamplerResult(quasi_dists=[{0: 0.5205078125, 3: 0.4794921875}], metadata=[{'shots': 2048}])
```

## 次のステップ

<Admonition type="tip" title="Recommendations">
  - より大きな回路を処理できる高性能シミュレーション用。 または、ノイズモデルをシミュレーションに組み込むには、format@@0(simulate-with-qiskit-aer) を参照してください。
  - Quantum Composer をシミュレーションに使用する方法については、format@@0(https://learning.quantum.ibm.com/tutorial/explore-gates-and-circuits-with-the-quantum-composer) チュートリアルを参照してください。
  - [Qiskit Estimator API](/api/qiskit/qiskit.primitivities.Estimator) を参照してください。
  - [Qiskit Sampler API](/api/qiskit/qiskit.primitives.Sampler) 参照を読みます。
  - [Run](../run) セクションで物理システムでの実行方法を学びます。
</Admonition>
